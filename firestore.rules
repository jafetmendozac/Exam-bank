rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUnitru() {
      return request.auth.token.email.matches('.*@unitru.edu.pe$');
    }
    
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    /* ======================
       USERS
       ====================== */
    match /users/{userId} {
      // Crear usuario (solo su propio UID y correo UNITRU)
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.auth.token.email_verified == true
        && isUnitru();

      // Leer su propio perfil
      allow read: if isAuthenticated()
        && request.auth.uid == userId
        && request.auth.token.email_verified == true;

      // ✅ ADMIN: Puede leer TODOS los usuarios (para dashboard y UsersPage)
      allow read: if isAdmin();

      // Actualizar solo su propio perfil
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && request.auth.token.email_verified == true;

      // El admin puede actualizar datos de cualquier usuario
      allow update: if isAdmin();
      
      // Nadie borra usuarios desde el cliente
      allow delete: if false;
    }
    

    /* ======================
       COURSES
       ====================== */
    match /courses/{courseId} {
      allow read: if isAuthenticated() && isUnitru();
      allow create: if isAuthenticated() && isUnitru();
      allow update, delete: if isAdmin();
    }


    /* ======================
       TEACHERS
       ====================== */
    match /teachers/{teacherId} {
      allow read: if isAuthenticated() && isUnitru();
      allow create: if isAuthenticated() && isUnitru();
      allow update, delete: if isAdmin();
    }
    

    /* ======================
       EXAMS
       ====================== */
    match /exams/{examId} {
      // Leer exámenes: cualquier usuario UNITRU autenticado
      allow read: if isAuthenticated() && isUnitru();
      
      // ✅ ADMIN: Puede leer TODOS (para dashboard stats)
      allow read: if isAdmin();

      // Crear exámenes: usuarios autenticados UNITRU
      allow create: if isAuthenticated() && isUnitru();

      // Actualizar: el que lo subió O usuarios @unitru (para aprobar/actualizar ratings)
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId || 
        request.auth.uid == resource.data.uploadedBy ||
        isUnitru()
      );

      // Borrar: solo el que lo subió o admin
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.uploadedBy ||
        isAdmin()
      );
    }
    
    
    /* ======================
       RATINGS
       ====================== */
    match /ratings/{ratingId} {
      // Lectura: Todos los usuarios autenticados
      allow read: if isAuthenticated();
      
      // Creación: Usuario autenticado @unitru
      allow create: if isAuthenticated() 
        && isUnitru()
        && request.auth.uid == request.resource.data.userId;
      
      // Actualización: Solo el dueño
      allow update: if isAuthenticated() 
        && request.auth.uid == resource.data.userId
        && request.resource.data.examId == resource.data.examId
        && request.resource.data.userId == resource.data.userId;
      
      // Eliminación: El dueño o admin
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        isAdmin()
      );
    }
    
    
    /* ======================
       REPORTS
       ====================== */
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isUnitru();
      allow update, delete: if isAdmin();
    }
    
    
    /* ======================
       ✅ DOWNLOAD LOGS (Para dashboard stats)
       ====================== */
    match /downloadLogs/{logId} {
      // Crear log cuando alguien descarga
      allow create: if request.auth != null
      
      // Admin puede leer todos (para stats)
      allow read: if isAdmin();
      
      // Usuario puede leer solo los suyos
      allow read: if isAuthenticated() && 
                    request.auth.uid == resource.data.userId;
    }
    
  }
}
